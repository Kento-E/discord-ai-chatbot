# GitHub Copilot 指示書

このプロジェクトで作業する際は、以下のルールを厳守してください。

## 言語設定

- **すべての出力は日本語で行うこと**
  - コミットメッセージは日本語で記述すること
  - PR のタイトルは日本語で記述すること
  - PR の Description（説明文）は日本語で記述すること
  - Issueのタイトルは日本語で記述すること
  - Issueの本文は日本語で記述すること
  - コメントを追加する場合も日本語で記述すること
  - コード内のコメントを追加する場合も日本語で記述すること
  - レビューコメントは日本語で記述すること

## コミットハッシュの表記ルール

- **コミットハッシュは必ず前後に半角スペースを入れて素のまま記載すること（例: ...修正は 778aa44 で対応済み）**
  - Markdown リンクやインラインコード、引用、装飾は一切使わないこと
  - 7 文字以上の 16 進英数字のみを使い、コミットハッシュとして認識できる形式にすること
  - 例: ...修正は 778aa44 で対応済み
  - 誤: ...修正は[778aa44](https://github.com/...)で対応済み
  - 誤: ...修正は`778aa44`で対応済み
  - GitHub は半角スペースで区切られたコミットハッシュを自動でリンク化するため、装飾は不要
  - Copilot や自動生成ツールもこのルールを厳守すること

## Markdown スタイル

Markdown ファイルを生成・編集する際は、以下のルールを厳守してください。

### 見出しの前後に空行を入れる

- すべての見出し（#, ##, ### など）の直前・直後に必ず 1 行の空行を入れること。

### その他の推奨ルール

- 箇条書きやコードブロックの前後にも適切な空行を入れる
- markdownlint の警告が出ないよう、一般的な MarkdownLint ルールに従う
- Copilot が自動生成する際もこのルールを必ず守ること

## PR 説明文の管理

- **PR 説明文を更新する際は、既存の HTML コメントを必ず保持すること**
  - 特に `<!-- for GitHub Copilot review rule -->` で囲まれた部分は絶対に削除しないこと
  - PR テンプレートの区切り線（`---`）以降の内容は常に保持すること
- **`report_progress` ツールを使用する際の注意**
  - PR テンプレートの HTML コメントを含めた完全な説明文を渡すこと
  - 説明文の最後に必ず以下の形式でテンプレートのコメントを含めること:

```markdown
## 変更内容

（あなたの説明文）

<!-- ここにPRの説明を記載してください -->
<!-- 以下の区切り線とコメントは削除・変更しないでください -->

---

<!-- for GitHub Copilot review rule -->
<!--
必ず、日本語でレビューしてください。レビュー結果を日本語で記載してください。
PRのタイトルを修正すべきであれば指摘してください。
-->
<!-- for GitHub Copilot review rule -->
```

## コーディング指示

このプロジェクトでコードを作成・編集する際は、以下のルールを厳守してください。

### エラーハンドリング

#### 必須チェック項目

- **リストや配列へのアクセス前に空チェックを実施**
  - `list[0]`のようなアクセスの前に、必ず`if not list:`または`if len(list) > 0:`でチェック
  - 例: `if similar_messages: first_message = similar_messages[0]`

- **`random.choice()`などの関数は空リストでエラーになるため事前チェック必須**
  - 空リストで`random.choice()`を呼ぶとIndexErrorが発生
  - 例: `if endings: ending = random.choice(endings) else: ending = "。"`

- **`dict.get()`でデフォルト値を指定し、Noneチェックを追加**
  - `dict.get(key, default_value)`を使用してNone回避
  - 取得後も値が空でないことを確認
  - 例: `greetings = persona.get('sample_greetings', []); if greetings: ...`

- **ファイル・ディレクトリ操作前に存在確認**
  - ディレクトリ作成: `os.makedirs(path, exist_ok=True)`
  - ファイル存在確認: `if os.path.exists(file_path):`

#### 正規表現の結果処理

- **`re.split()`の結果から空文字列を除外**
  - 例: `sentences = [s for s in re.split(r'[。！？]', text) if s.strip()]`
  - 空リスト対策: `response = sentences[0] if sentences else fallback_text`

### コード品質

#### リンター実行（必須）

**コード変更後は必ずリンターを実行してコミットすること**

コミット前に以下のいずれかの方法でリンターを実行し、すべてのエラーを修正してください：

##### Copilot向け特別指示

**Copilotがコードを生成する場合、`report_progress`でコミットする前に必ずリンターを実行して修正すること**

**基本方針: 変更したファイルのみをリンターで検証**

```bash
# 変更したファイルのみリンター実行（通常はこれで十分）
# 例: src/ai_chatbot.py を変更した場合
black src/ai_chatbot.py
isort --profile black src/ai_chatbot.py
autoflake --in-place --remove-all-unused-imports --remove-unused-variables src/ai_chatbot.py
flake8 src/ai_chatbot.py

# 複数ファイルを変更した場合
black src/file1.py src/file2.py
isort --profile black src/file1.py src/file2.py
autoflake --in-place --remove-all-unused-imports --remove-unused-variables src/file1.py src/file2.py
flake8 src/file1.py src/file2.py
```

**重要**: リンターエラーがある状態でコミットしないでください。CI/CDパイプラインで失敗します。

#### 基本ルール

- **未使用の変数・importは削除すること**
  - コミット前にリンター（flake8/pylint）を実行して確認
  - IDE/エディタの警告にも注意

- **変数名は明確に**
  - 目的が分かる名前を使用（例: `query_lower`は小文字変換されたクエリと分かる）
  - 略語は慣例的なもののみ使用

- **コメントは必要に応じて追加**
  - 複雑なロジックには説明コメントを追加
  - 自明なコードには不要
  - 既存のコメントスタイルに合わせる
  - **DRY原則に従う**: コメントにコードと同じ情報（変数名、定数値、モデル名など）を記載しない

- **削除された機能に関連するコードは完全に削除すること**
  - 参考資料、コメント、使用例なども含めてすべて削除
  - 過去の実装を参考として残さない
  - テストコード内の参考情報表示コードも同様に削除

### テストファイルの管理

- **PR専用テストファイル（プライベート関数のユニットテストなど）は、テスト完了後に同じPR内で削除すること**
  - プライベート関数（`_`で始まる関数）専用のテストファイルは永続化しない
  - 公開APIを通じて機能をテストできる場合、プライベート関数専用のテストファイルは不要
  - 既存のテストファイル（`test_response_logic.py`など）にテストケースを追加する方が保守性が高い
  - 実装検証のために一時的にプライベート関数をテストすることは有用だが、検証完了後は**必ず同じPR内で削除**すること

#### コード変更時のテスト影響確認

コードやドキュメントを変更した際は、既存テストへの影響を必ず確認すること：

- **参照される文字列を変更した場合**
  - プロンプト設定、ドキュメント、エラーメッセージなど、他のファイルから参照される文字列を変更した際は、その文字列を使用している全テストファイルを確認すること
  - 例: プロンプト内の「AIアドバイザー」を「専門AIアシスタント」に変更した場合、テストコード内で「AIアドバイザー」という文字列を検証している箇所を更新する
  - `grep -r "変更した文字列" src/test_*.py` で影響範囲を確認

- **コード変更後のテスト実行**
  - コード変更後は必ず関連するすべてのテストを実行し、影響を確認すること
  - 変更が完了したと思った時点で、もう一度全テストを実行して最終確認すること
  - テストが失敗した場合は、コード変更による意図的な仕様変更か、バグかを判断し、適切に対応すること

## ドキュメント作成指示

ドキュメントを作成・編集する際は、以下のルールを厳守してください。

### 作業前の確認事項

ドキュメントを作成・更新する前に、必ず以下を確認してください：

1. ドキュメントのチェックリストを確認（「新規ドキュメント作成時のチェックリスト」「既存ドキュメント更新時のチェックリスト」）
2. 対象ドキュメントの責任分掌を確認

### ドキュメントの責任分掌

各ドキュメントには明確な役割があります。内容を適切なファイルに配置してください：

#### README.md

- **目的**: ユーザー向けクイックスタートガイド
- **内容**: 
  - プロジェクトの概要
  - 必要な環境設定の概要
  - 基本的な実行手順
  - 高レベルの機能説明
- **避けるべき内容**: 詳細な技術仕様、詳細なトラブルシューティング、内部アーキテクチャ

#### .github/workflows/README.md

- **目的**: ワークフローの詳細ドキュメント
- **内容**:
  - 各ワークフローの概要説明
  - トリガー条件の詳細
  - 必要な環境変数と権限
  - 動作の詳細
  - トラブルシューティング

#### docs/*.md（専門ドキュメント）

- **目的**: 複数のファイル・コンポーネントにまたがる複雑な機能の詳細説明
- **原則**: **基本的には関連ファイルと同じ場所に配置**すべき。docs/配下は例外的な使用に限定する

### 作成してはいけないドキュメント

永続ドキュメント（README.md、docs/*.md など）には、以下のような内容を記載しないでください：

#### リリースノート的な内容

- **禁止される表現**: 
  - 「以前は〜だった」「今回〜に変更した」「〜を修正した」といった過去形の説明
  - 「改善前」「改善後」「Before/After」などの比較表現
  - パフォーマンス改善の数値比較（「起動時間: 8秒 → 0.01秒」など）
  - 「〜を実装しました」「〜を追加しました」などの完了形
- **⚠️ 注意**: 「技術詳細」や「実装の説明」という名目でも、上記の表現が含まれる場合はリリースノートです
- **理由**: 永続ドキュメントは「現在の動作」を説明するものであり、変更履歴を記録するものではない
- **記載すべき場所**:
  - **PR説明文**: 変更内容の詳細な説明、Before/After比較、パフォーマンス改善結果
  - **Git コミットメッセージ**: 変更の理由と内容
  - **コード内のdocstring/コメント**: 実装の詳細（現在の動作のみ）

### DRY原則（Don't Repeat Yourself）

情報の重複を避け、単一情報源（Single Source of Truth）を維持してください：

#### 重複を避けるべき内容

1. **詳細な技術説明**: 1つの専門ドキュメントに記載し、他のドキュメントからは参照リンクで誘導
2. **設定値**: コード（ワークフローファイルなど）を情報源とし、ドキュメントからは参照リンクを使用
3. **手順**: 1箇所に詳細を記載し、他の場所では要約+参照リンクを使用
4. **料金・プラン情報**: 詳細は専用セクションに記載し、他の箇所では概要+参照リンクのみ
5. **技術仕様（モデル名、バージョンなど）**: 具体的な値は1箇所のみに記載し、他は参照リンクを使用

#### 参照リンクの使用

重複を避けるため、詳細情報へは参照リンクを使用してください：

```markdown
詳細なアーキテクチャについては [docs/RELEASE_FLOW.md](../../docs/RELEASE_FLOW.md) を参照してください。

設定値については [ワークフローファイル](upload-knowledge-to-release.yml) を参照してください。

無料で利用可能（詳細は[料金について](#料金について)を参照）
```

### 新規ドキュメント作成時のチェックリスト

新しいドキュメントを作成する前に、以下を確認してください：

1. **既存ドキュメントに追加できないか**: 既存の適切なドキュメントがあれば、そこに追加
2. **責任分掌は明確か**: このドキュメントの役割と対象読者が明確か
3. **重複はないか**: 他のドキュメントと重複する内容がないか
4. **参照リンクは適切か**: 詳細情報への適切な参照リンクがあるか
5. **⚠️ リリースノート的な内容が含まれていないか**: 以下の表現がある場合は削除
   - 「改善前」「改善後」「Before/After」などの比較
   - 「以前は〜」「今回〜に変更」「〜を修正した」などの過去形
   - パフォーマンス改善の数値比較（「8秒→0.01秒」など）
   - **これらは全てPR説明文に記載すべき内容です**

### 既存ドキュメント更新時のチェックリスト

ドキュメントを更新する際は、以下を確認してください：

1. **責任範囲内か**: そのドキュメントの責任範囲内の内容か
2. **重複が発生していないか**: 他のドキュメントとの重複が発生していないか
3. **参照リンクは更新されているか**: 関連する参照リンクが正しく更新されているか
4. **一貫性**: フォーマットやトーンが既存の内容と一貫しているか

## GitHub Actions ワークフロー指示

GitHub Actionsワークフローを作成・編集する際は、以下のルールを厳守してください。

### 環境変数の一貫性

#### 必須チェック項目

- **ワークフロー内の全ステップで必要な環境変数を設定すること**
  - あるステップで使用している環境変数は、それを必要とする他のすべてのステップでも設定する
  - 特にSecretsを参照する環境変数は漏れがないか注意深く確認する

- **ドキュメント（README.md）と実際のワークフローファイルの整合性を保つ**
  - ワークフローの「必要な環境変数」セクションに記載されている変数は、すべて実際のワークフローファイルで設定されていることを確認
  - ワークフローファイルで使用している環境変数は、すべてドキュメントに記載されていることを確認

#### 環境変数設定のベストプラクティス

- **環境変数は必要なステップすべてに明示的に設定する**
  - グローバルに設定するのではなく、各ステップで明示的に設定することを推奨
  - これにより、どのステップがどの環境変数を使用しているかが明確になる

- **環境変数の設定漏れを防ぐチェックリスト**
  1. ワークフロー内で使用される環境変数をすべてリストアップ
  2. 各ステップで必要な環境変数を特定
  3. 各ステップの`env:`セクションに必要な環境変数がすべて設定されているか確認
  4. ドキュメント（.github/workflows/README.md）の「必要な環境変数」セクションを更新

### ワークフロー作成時のチェックリスト

新しいワークフローを作成する際は、以下を確認してください：

- [ ] 各ステップで必要な環境変数がすべて`env:`セクションに設定されているか
- [ ] Secretsを参照する環境変数に設定漏れがないか
- [ ] `.github/workflows/README.md`の「必要な環境変数」セクションが更新されているか
- [ ] 同じ環境変数を使用する他のワークフローとの整合性が取れているか

### ワークフロー更新時のチェックリスト

既存のワークフローを更新する際は、以下を確認してください：

- [ ] 新しいステップを追加した場合、必要な環境変数がすべて設定されているか
- [ ] 環境変数を追加・削除した場合、`.github/workflows/README.md`が更新されているか
- [ ] 他のワークフローで同じパターンの変更が必要でないか確認

## Issue作成のベストプラクティス

### タイトル

- 明確で簡潔なタイトルを使用すること
- 問題や機能リクエストの本質を捉えること
- プレフィックスを使用して種類を明確にすること（例: `[Bug]`, `[Feature]`, `[Enhancement]`）

### 本文

- **問題の説明**: 何が問題か、または何を実現したいかを明確に記述
- **再現手順**: バグの場合、問題を再現する手順を詳細に記述
- **期待される動作**: 本来どうあるべきかを記述
- **実際の動作**: 現在何が起こっているかを記述
- **環境情報**: 必要に応じて、OS、Pythonバージョン、依存関係のバージョンなどを記述
- **スクリーンショット/ログ**: 問題を視覚的に示すスクリーンショットやエラーログを添付

### ラベル

- 適切なラベルを付けてIssueを分類すること
- 例: `bug`, `enhancement`, `documentation`, `question`, `help wanted`

## コードレビュー指示

コードレビューを実施する際は、以下のルールを厳守してください。

### レビューの基本方針

- **すべてのレビューコメントは日本語で記述すること**
- レビュー結果を日本語で記載すること
- PRのタイトルを修正すべきであれば指摘すること

### コード品質のチェック項目

#### エラーハンドリング

- **リストや配列へのアクセス前に空チェックが実施されているか**
  - `list[0]`のようなアクセスの前に、`if not list:`または`if len(list) > 0:`でチェックされているか
  - 例: `if similar_messages: first_message = similar_messages[0]`

- **`random.choice()`などの関数使用前に事前チェックがあるか**
  - 空リストで`random.choice()`を呼ぶとIndexErrorが発生
  - 例: `if endings: ending = random.choice(endings) else: ending = "。"`

- **`dict.get()`でデフォルト値が指定され、Noneチェックが追加されているか**
  - `dict.get(key, default_value)`を使用してNone回避
  - 取得後も値が空でないことを確認
  - 例: `greetings = persona.get('sample_greetings', []); if greetings: ...`

- **ファイル・ディレクトリ操作前に存在確認がされているか**
  - ディレクトリ作成: `os.makedirs(path, exist_ok=True)`
  - ファイル存在確認: `if os.path.exists(file_path):`

#### 正規表現の結果処理

- **`re.split()`の結果から空文字列が除外されているか**
  - 例: `sentences = [s for s in re.split(r'[。！？]', text) if s.strip()]`
  - 空リスト対策: `response = sentences[0] if sentences else fallback_text`

#### コード品質

- **未使用の変数・importが存在しないか**
  - リンター（flake8/pylint）の警告がないか確認
  - IDE/エディタの警告がないか確認

- **変数名は明確か**
  - 目的が分かる名前が使用されているか（例: `query_lower`は小文字変換されたクエリと分かる）
  - 略語は慣例的なもののみ使用されているか

- **コメントは適切か**
  - 複雑なロジックには説明コメントがあるか
  - 自明なコードに不要なコメントがないか
  - 既存のコメントスタイルに合っているか
  - **DRY原則に従っているか**: コメントにコードと同じ情報（変数名、定数値、モデル名など）が記載されていないか

- **削除された機能に関連するコードが完全に削除されているか**
  - 参考資料、コメント、使用例なども含めてすべて削除されているか
  - 過去の実装が参考として残されていないか
  - テストコード内の参考情報表示コードも同様に削除されているか

#### テストファイルの確認

- **PR専用テストファイルがテスト完了後に削除されているか**
  - プライベート関数（`_`で始まる関数）専用のテストファイルは永続化されていないか
  - テスト内で実装ロジックを複製していないか
  - 実際のコードをインポートせず、独自実装でテストしていないか

- **コード変更がテストに影響を与えていないか確認**
  - プロンプト設定、ドキュメント、エラーメッセージなど、参照される文字列を変更した場合、関連するテストファイルが更新されているか
  - `grep -r "変更した文字列" src/test_*.py` で影響範囲が確認されているか

#### リンター実行の確認

- **コード変更後にリンターが実行されているか**
  - black, isort, autoflake, flake8 が実行されているか
  - リンターエラーがない状態でコミットされているか
  - CI/CDパイプラインで失敗しないか

#### セキュリティチェック

- **機密情報がコードに含まれていないか**
  - APIキー、パスワード、トークンなどがハードコードされていないか
  - 環境変数またはSecretsが適切に使用されているか
