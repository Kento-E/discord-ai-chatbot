# GitHub Actions ワークフロー

このディレクトリには、リポジトリの自動化を行うGitHub Actionsワークフローが含まれています。

## ワークフロー一覧

### 1. Enable Auto-Merge on PR Creation (`auto-merge.yml`)

#### 概要

PRが作成されたときに、GitHubの自動マージ機能を有効化するワークフローです。承認とステータスチェックが完了すると、GitHubが自動的にSquash and Mergeを実行します。

#### トリガー条件

- イベント: `pull_request` (opened, reopened, ready_for_review)
- 条件: ドラフトPRでない

#### 動作

1. PR情報を表示
2. GitHubの自動マージ機能（Auto-Merge）を有効化
3. ブランチ保護ルールで要求される承認とステータスチェックが完了すると、GitHubが自動的にマージを実行

#### 必要な権限

- `contents: write` - リポジトリへの書き込み
- `pull-requests: write` - PRの操作

#### GitHubの自動マージ機能について

このワークフローは、GitHubの**ネイティブ自動マージ機能**を利用します：

- **利点**:
  - ブランチ保護ルールと完全に互換性がある
  - 「Copilotとコラボレーションしたユーザー」の制約も正しく処理される
  - GitHub UIから自動マージのステータスが確認できる
  
- **動作フロー**:
  1. PRが作成される → ワークフローが自動マージを有効化
  2. レビュアーが承認する
  3. すべてのステータスチェックが成功
  4. → GitHubが自動的にSquash and Mergeを実行

#### 注意事項

- ブランチ保護ルールで要求される承認とステータスチェックがすべて満たされるまで、マージは実行されません
- GitHubの自動マージ機能を使用するため、ブランチ保護ルールとの互換性が保証されています
- 自動マージが有効化できない場合（権限不足など）、エラーメッセージが表示されますが、ワークフローは成功として扱われます
- マージコンフリクトがある場合、自動マージは実行されません

### 2. Auto Delete Branch on Merge (`auto-delete-branch.yml`)

#### 概要

PRがマージされた後、ソースブランチを自動的に削除するワークフローです。

#### トリガー条件

- イベント: `pull_request` (closed)
- 条件: PRがマージされた（`merged == true`）

#### 動作

1. マージされたPRのブランチ情報を取得
2. ソースブランチを削除

#### 必要な権限

- `contents: write` - リポジトリへの書き込み

#### 注意事項

- 保護ブランチは削除されません
- 既に削除されているブランチの場合、エラーは無視されます
- フォークからのPRの場合、元のリポジトリのブランチは削除されません

## 使用方法

これらのワークフローは自動的に実行されるため、特別な設定は不要です。

### 自動マージを無効にしたい場合

1. `.github/workflows/auto-merge.yml` を削除または無効化
2. または、PRにラベルを追加してスキップする条件を追加

### 自動ブランチ削除を無効にしたい場合

1. `.github/workflows/auto-delete-branch.yml` を削除または無効化
2. または、リポジトリ設定で「Automatically delete head branches」を有効化

## トラブルシューティング

### ワークフローが実行されない

- GitHub Actionsが有効になっているか確認
- リポジトリの権限設定を確認
- ワークフローファイルの構文エラーを確認

### 自動マージが実行されない

**自動マージ機能が有効化されているのにマージされない場合:**

考えられる原因と確認項目:

1. **承認の不足**
   - ブランチ保護ルールで要求される承認数が満たされていない
   - PR画面の「Reviewers」セクションを確認
   - GitHub Copilot等のBotとコラボレーションしたユーザーによる承認は無効になる場合があります

2. **ステータスチェックの未完了**
   - 必要なステータスチェックが成功していない
   - PR画面の「Checks」タブを確認
   - すべての必須チェックが緑色（成功）になっている必要があります

3. **マージコンフリクト**
   - ベースブランチとコンフリクトがある
   - PR画面に「This branch has conflicts」と表示される
   - コンフリクトを解決する必要があります

4. **ブランチ保護ルールの制約**
   - リポジトリ設定: `Settings > Branches > Branch protection rules`
   - 「Require approvals」の設定を確認
   - 「Require status checks to pass」の設定を確認

**GitHubの自動マージ機能について:**

- PR画面で「Enable auto-merge」ボタンが表示されている場合、そのボタンをクリックして手動で有効化することもできます
- 自動マージが有効化されると、PR画面に「This pull request will auto-merge」と表示されます

### ブランチが削除されない

- ブランチが保護されていないか確認
- ワークフローの実行ログを確認
- リポジトリの権限設定を確認

## カスタマイズ

### 承認数の変更

`auto-merge.yml` の以下の行を変更：

```yaml
if: fromJSON(steps.check_approvals.outputs.result) >= 1
```

例: 2件以上の承認が必要な場合は `>= 2` に変更

### マージ方法の変更

`auto-merge.yml` の以下の行を変更：

```yaml
merge_method: 'squash'
```

選択肢: `squash`, `merge`, `rebase`
