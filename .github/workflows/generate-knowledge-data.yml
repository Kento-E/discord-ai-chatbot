name: çŸ¥è­˜ãƒ‡ãƒ¼ã‚¿ã®ç”Ÿæˆã¨ä¿å­˜

on:
  workflow_dispatch:  # æ‰‹å‹•å®Ÿè¡Œã‚’è¨±å¯
    inputs:
      reason:
        description: 'å®Ÿè¡Œç†ç”±ï¼ˆä»»æ„ï¼‰'
        required: false
        default: 'çŸ¥è­˜ãƒ‡ãƒ¼ã‚¿ã®æ›´æ–°'
  schedule:
    - cron: '0 0 1 */2 *'  # 2ãƒ¶æœˆã”ã¨ã«è‡ªå‹•å®Ÿè¡Œï¼ˆã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆä¿æŒæœŸé–“90æ—¥ã«å¯¾ã—ã¦30æ—¥ã®ä½™è£•ã‚’ç¢ºä¿ï¼‰

permissions:
  contents: read

jobs:
  generate-and-encrypt:
    runs-on: ubuntu-latest
    timeout-minutes: 60  # ãƒ‡ãƒ¼ã‚¿é‡ã®å¢—åŠ ã‚’è€ƒæ…®ã—ã¦ä½™è£•ã‚’æŒã£ãŸè¨­å®š

    steps:
      - name: ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v6

      - name: Pythonã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-python@v6
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: ä¾å­˜ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt

      - name: ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å–å¾—
        env:
          DISCORD_TOKEN: ${{ secrets.DISCORD_TOKEN }}
          TARGET_GUILD_ID: ${{ secrets.TARGET_GUILD_ID }}
          EXCLUDED_CHANNELS: ${{ secrets.EXCLUDED_CHANNELS }}
        run: |
          echo "ðŸ“¥ Discordã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å–å¾—ä¸­..."
          python src/fetch_messages.py

      - name: åŸ‹ã‚è¾¼ã¿ãƒ‡ãƒ¼ã‚¿ã‚’ç”Ÿæˆ
        run: |
          echo "ðŸ”„ åŸ‹ã‚è¾¼ã¿ãƒ‡ãƒ¼ã‚¿ã‚’ç”Ÿæˆä¸­..."
          python src/prepare_dataset.py

      - name: çŸ¥è­˜ãƒ‡ãƒ¼ã‚¿ã‚’æš—å·åŒ–
        env:
          ENCRYPTION_KEY: ${{ secrets.ENCRYPTION_KEY }}
        run: |
          echo "ðŸ” çŸ¥è­˜ãƒ‡ãƒ¼ã‚¿ã‚’æš—å·åŒ–ä¸­..."
          
          # å¿…è¦ãªãƒ‡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã™ã‚‹ã‹ç¢ºèª
          if [ ! -f data/messages.json ] || [ ! -f data/embeddings.json ]; then
            echo "âŒ ã‚¨ãƒ©ãƒ¼: å¿…è¦ãªãƒ‡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
            exit 1
          fi
          
          # dataãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå†…ã®JSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’åœ§ç¸®ãƒ»æš—å·åŒ–
          tar czf - data/*.json | openssl enc -aes-256-cbc -salt -pbkdf2 -pass env:ENCRYPTION_KEY -out knowledge-data.enc
          
          echo "âœ… æš—å·åŒ–å®Œäº†"
          ls -lh knowledge-data.enc

      - name: æš—å·åŒ–ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã¨ã—ã¦ä¿å­˜
        uses: actions/upload-artifact@v6
        with:
          name: knowledge-data-encrypted
          path: knowledge-data.enc
          retention-days: 90
          compression-level: 0  # æ—¢ã«åœ§ç¸®æ¸ˆã¿

      - name: å®Ÿè¡Œçµæžœã‚’ã‚µãƒžãƒªãƒ¼ã«å‡ºåŠ›
        if: always()
        run: |
          if [ '${{ job.status }}' == 'success' ]; then
            echo "## âœ… çŸ¥è­˜ãƒ‡ãƒ¼ã‚¿ã®ç”Ÿæˆ: æˆåŠŸ" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "çŸ¥è­˜ãƒ‡ãƒ¼ã‚¿ãŒæ­£å¸¸ã«ç”Ÿæˆã•ã‚Œã€æš—å·åŒ–ã•ã‚Œã¦ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã«ä¿å­˜ã•ã‚Œã¾ã—ãŸã€‚" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ðŸ“¦ ä¿å­˜æƒ…å ±" >> $GITHUB_STEP_SUMMARY
            echo "- **ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆå**: knowledge-data-encrypted" >> $GITHUB_STEP_SUMMARY
            echo "- **ä¿æŒæœŸé–“**: 90æ—¥" >> $GITHUB_STEP_SUMMARY
            echo "- **æš—å·åŒ–æ–¹å¼**: AES-256-CBC" >> $GITHUB_STEP_SUMMARY
          else
            echo "## âŒ çŸ¥è­˜ãƒ‡ãƒ¼ã‚¿ã®ç”Ÿæˆ: å¤±æ•—" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "çŸ¥è­˜ãƒ‡ãƒ¼ã‚¿ã®ç”Ÿæˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ç¢ºèªäº‹é …" >> $GITHUB_STEP_SUMMARY
            echo "1. **DISCORD_TOKEN**: æ­£ã—ã„Botãƒˆãƒ¼ã‚¯ãƒ³ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹" >> $GITHUB_STEP_SUMMARY
            echo "2. **TARGET_GUILD_ID**: æ­£ã—ã„ã‚µãƒ¼ãƒãƒ¼IDãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹" >> $GITHUB_STEP_SUMMARY
            echo "3. **ENCRYPTION_KEY**: æš—å·éµãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“ å®Ÿè¡Œæƒ…å ±" >> $GITHUB_STEP_SUMMARY
          echo "- **å®Ÿè¡Œç†ç”±**: ${{ github.event.inputs.reason || 'çŸ¥è­˜ãƒ‡ãƒ¼ã‚¿ã®æ›´æ–°' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **å®Ÿè¡Œè€…**: @${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "- **å®Ÿè¡Œæ—¥æ™‚**: $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
