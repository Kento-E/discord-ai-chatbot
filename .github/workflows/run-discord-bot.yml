name: Discord Botã®å®Ÿè¡Œ

on:
  workflow_dispatch:  # æ‰‹å‹•å®Ÿè¡Œã‚’è¨±å¯
    inputs:
      reason:
        description: 'Botã‚’èµ·å‹•ã™ã‚‹ç†ç”±ï¼ˆä»»æ„ï¼‰'
        required: false
        default: 'æ‰‹å‹•èµ·å‹•'
      timeout_minutes:
        description: 'å®Ÿè¡Œæ™‚é–“ã®ä¸Šé™ï¼ˆåˆ†ï¼‰ã€‚æœ€å¤§360åˆ†ï¼ˆ6æ™‚é–“ï¼‰'
        required: false
        default: '60'
        type: choice
        options:
          - '30'
          - '60'
          - '120'
          - '180'
          - '360'

permissions:
  contents: read

jobs:
  run-bot:
    runs-on: ubuntu-latest
    timeout-minutes: ${{ fromJSON(github.event.inputs.timeout_minutes || '60') }}

    steps:
      - name: ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4

      - name: Pythonã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: ä¾å­˜ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt

      - name: Discord Botã‚’èµ·å‹•
        env:
          DISCORD_TOKEN: ${{ secrets.DISCORD_TOKEN }}
          TARGET_GUILD_ID: ${{ secrets.TARGET_GUILD_ID }}
        run: |
          echo "ðŸ¤– Discord Botã‚’èµ·å‹•ã—ã¾ã™"
          echo "èµ·å‹•ç†ç”±: ${{ github.event.inputs.reason || 'æ‰‹å‹•èµ·å‹•' }}"
          echo "å®Ÿè¡Œæ™‚é–“ä¸Šé™: ${{ github.event.inputs.timeout_minutes || '60' }}åˆ†"
          echo ""
          echo "âš ï¸ æ³¨æ„: GitHub Actionsã®åˆ¶é™ã«ã‚ˆã‚Šã€æœ€å¤§6æ™‚é–“ï¼ˆ360åˆ†ï¼‰ã¾ã§å®Ÿè¡Œå¯èƒ½ã§ã™"
          echo "âš ï¸ ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã«é”ã™ã‚‹ã¨è‡ªå‹•çš„ã«åœæ­¢ã—ã¾ã™"
          echo ""
          echo "ðŸ”„ Botã‚’èµ·å‹•ã—ã¦ã„ã¾ã™..."
          python src/main.py

      - name: å®Ÿè¡Œçµæžœã‚’ã‚µãƒžãƒªãƒ¼ã«å‡ºåŠ›
        if: always()
        run: |
          if [ '${{ job.status }}' == 'success' ]; then
            echo "## âœ… Discord Bot: æ­£å¸¸çµ‚äº†" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Botã¯æ­£å¸¸ã«çµ‚äº†ã—ã¾ã—ãŸã€‚" >> $GITHUB_STEP_SUMMARY
          elif [ '${{ job.status }}' == 'cancelled' ]; then
            echo "## â¹ï¸ Discord Bot: ã‚­ãƒ£ãƒ³ã‚»ãƒ«" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Botã®å®Ÿè¡ŒãŒã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œã¾ã—ãŸã€‚" >> $GITHUB_STEP_SUMMARY
          else
            echo "## âŒ Discord Bot: ã‚¨ãƒ©ãƒ¼çµ‚äº†" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Botã®å®Ÿè¡Œä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚" >> $GITHUB_STEP_SUMMARY
            echo "è©³ç´°ãªã‚¨ãƒ©ãƒ¼å†…å®¹ã¯ä¸Šè¨˜ã®ãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ç¢ºèªäº‹é …" >> $GITHUB_STEP_SUMMARY
            echo "1. **DISCORD_TOKEN**: æ­£ã—ã„Bot ãƒˆãƒ¼ã‚¯ãƒ³ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹" >> $GITHUB_STEP_SUMMARY
            echo "2. **TARGET_GUILD_ID**: æ­£ã—ã„ã‚µãƒ¼ãƒãƒ¼IDãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹" >> $GITHUB_STEP_SUMMARY
            echo "3. **Botæ¨©é™**: BotãŒã‚µãƒ¼ãƒãƒ¼ã«å‚åŠ ã—ã¦ã„ã‚‹ã‹" >> $GITHUB_STEP_SUMMARY
            echo "4. **Intentè¨­å®š**: Discord Developer Portalã§å¿…è¦ãªIntentsãŒæœ‰åŠ¹åŒ–ã•ã‚Œã¦ã„ã‚‹ã‹" >> $GITHUB_STEP_SUMMARY
            echo "   - MESSAGE CONTENT INTENT" >> $GITHUB_STEP_SUMMARY
            echo "   - SERVER MEMBERS INTENT" >> $GITHUB_STEP_SUMMARY
            echo "   - GUILDS INTENT" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“ å®Ÿè¡Œæƒ…å ±" >> $GITHUB_STEP_SUMMARY
          echo "- **èµ·å‹•ç†ç”±**: ${{ github.event.inputs.reason || 'æ‰‹å‹•èµ·å‹•' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆè¨­å®š**: ${{ github.event.inputs.timeout_minutes || '60' }}åˆ†" >> $GITHUB_STEP_SUMMARY
          echo "- **å®Ÿè¡Œè€…**: @${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "- **å®Ÿè¡Œæ—¥æ™‚**: $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
