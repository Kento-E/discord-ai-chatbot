name: Discord Botã®å®Ÿè¡Œ

on:
  workflow_dispatch:  # æ‰‹å‹•å®Ÿè¡Œã‚’è¨±å¯
    inputs:
      reason:
        description: 'Botã‚’èµ·å‹•ã™ã‚‹ç†ç”±ï¼ˆä»»æ„ï¼‰'
        required: false
        default: 'æ‰‹å‹•èµ·å‹•'
      timeout_minutes:
        description: 'å®Ÿè¡Œæ™‚é–“ã®ä¸Šé™ï¼ˆåˆ†ï¼‰ã€‚æœ€å¤§360åˆ†ï¼ˆ6æ™‚é–“ï¼‰'
        required: false
        default: '60'
        type: choice
        options:
          - '30'
          - '60'
          - '120'
          - '180'
          - '360'

permissions:
  contents: read

jobs:
  run-bot:
    runs-on: ubuntu-latest
    timeout-minutes: ${{ fromJSON(github.event.inputs.timeout_minutes || '60') }}

    steps:
      - name: ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v6

      - name: Pythonã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-python@v6
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: ä¾å­˜ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt

      - name: æœ€æ–°ã®çŸ¥è­˜ãƒ‡ãƒ¼ã‚¿Releaseã‚’å–å¾—
        id: get-latest-release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ðŸ“¦ æœ€æ–°ã®çŸ¥è­˜ãƒ‡ãƒ¼ã‚¿Releaseã‚’æ¤œç´¢ä¸­..."

          # knowledge-data-* ã‚¿ã‚°ã®æœ€æ–°Releaseã‚’å–å¾—
          LATEST_RELEASE=$(gh release list --limit 100 --json tagName,createdAt \
            --jq '[.[] | select(.tagName | startswith("knowledge-data-"))] | sort_by(.createdAt) | reverse | .[0].tagName')

          if [ -z "$LATEST_RELEASE" ] || [ "$LATEST_RELEASE" = "null" ]; then
            echo "âŒ ã‚¨ãƒ©ãƒ¼: çŸ¥è­˜ãƒ‡ãƒ¼ã‚¿ã®ReleaseãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
            echo ""
            echo "çŸ¥è­˜ãƒ‡ãƒ¼ã‚¿ã‚’ç”Ÿæˆã™ã‚‹ã«ã¯ã€ä»¥ä¸‹ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„:"
            echo "  Actions â†’ 'çŸ¥è­˜ãƒ‡ãƒ¼ã‚¿ã®ç”Ÿæˆã¨ä¿å­˜' â†’ Run workflow"
            echo ""
            echo "è©³ç´°: .github/workflows/ENCRYPTION_KEY_SETUP.md ã‚’å‚ç…§"
            echo "found=false" >> $GITHUB_OUTPUT
            exit 1
          fi

          echo "âœ… æœ€æ–°Release: ${LATEST_RELEASE}"
          echo "tag_name=${LATEST_RELEASE}" >> $GITHUB_OUTPUT
          echo "found=true" >> $GITHUB_OUTPUT

      - name: æš—å·åŒ–ã•ã‚ŒãŸçŸ¥è­˜ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
        id: download-knowledge
        if: steps.get-latest-release.outputs.found == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG_NAME="${{ steps.get-latest-release.outputs.tag_name }}"
          echo "ðŸ“¥ çŸ¥è­˜ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ä¸­: ${TAG_NAME}"

          # Releaseã‹ã‚‰knowledge-data.encã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
          gh release download "${TAG_NAME}" \
            --pattern "knowledge-data.enc" \
            --dir . \
            --clobber

          if [ -f knowledge-data.enc ]; then
            echo "âœ… ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å®Œäº†"
            ls -lh knowledge-data.enc
            echo "success=true" >> $GITHUB_OUTPUT
          else
            echo "âŒ ã‚¨ãƒ©ãƒ¼: ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ"
            echo "success=false" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: çŸ¥è­˜ãƒ‡ãƒ¼ã‚¿ã‚’å¾©å·åŒ–
        if: steps.download-knowledge.outputs.success == 'true'
        env:
          ENCRYPTION_KEY: ${{ secrets.ENCRYPTION_KEY }}
        run: |
          echo "ðŸ”“ çŸ¥è­˜ãƒ‡ãƒ¼ã‚¿ã‚’å¾©å·åŒ–ä¸­..."

          if [ -f knowledge-data.enc ]; then
            if openssl enc -aes-256-cbc -d -pbkdf2 -pass env:ENCRYPTION_KEY -in knowledge-data.enc | tar xzf - -C ./; then
              echo "âœ… å¾©å·åŒ–å®Œäº†"
              ls -la data/
            else
              echo "âŒ ã‚¨ãƒ©ãƒ¼: å¾©å·åŒ–ã«å¤±æ•—ã—ã¾ã—ãŸ"
              echo "æš—å·éµ(ENCRYPTION_KEY)ãŒæ­£ã—ã„ã‹ç¢ºèªã—ã¦ãã ã•ã„"
              exit 1
            fi
          else
            echo "âš ï¸ æš—å·åŒ–ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
            exit 1
          fi

      - name: çŸ¥è­˜ãƒ‡ãƒ¼ã‚¿ã®ç¢ºèª
        run: |
          if [ ! -f data/embeddings.json ]; then
            echo "âŒ ã‚¨ãƒ©ãƒ¼: çŸ¥è­˜ãƒ‡ãƒ¼ã‚¿ãŒå­˜åœ¨ã—ã¾ã›ã‚“"
            echo ""
            echo "çŸ¥è­˜ãƒ‡ãƒ¼ã‚¿ã‚’ç”Ÿæˆã™ã‚‹ã«ã¯ã€ä»¥ä¸‹ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„:"
            echo "  Actions â†’ 'çŸ¥è­˜ãƒ‡ãƒ¼ã‚¿ã®ç”Ÿæˆã¨ä¿å­˜' â†’ Run workflow"
            echo ""
            echo "è©³ç´°: .github/workflows/ENCRYPTION_KEY_SETUP.md ã‚’å‚ç…§"
            exit 1
          else
            echo "âœ… çŸ¥è­˜ãƒ‡ãƒ¼ã‚¿ãŒåˆ©ç”¨å¯èƒ½ã§ã™"
          fi

      - name: Discord Botã‚’èµ·å‹•
        env:
          DISCORD_TOKEN: ${{ secrets.DISCORD_TOKEN }}
          TARGET_GUILD_ID: ${{ secrets.TARGET_GUILD_ID }}
        run: |
          echo "ðŸ¤– Discord Botã‚’èµ·å‹•ã—ã¾ã™"
          echo "èµ·å‹•ç†ç”±: ${{ github.event.inputs.reason || 'æ‰‹å‹•èµ·å‹•' }}"
          echo "å®Ÿè¡Œæ™‚é–“ä¸Šé™: ${{ github.event.inputs.timeout_minutes || '60' }}åˆ†"
          echo ""
          echo "âš ï¸ æ³¨æ„: GitHub Actionsã®åˆ¶é™ã«ã‚ˆã‚Šã€æœ€å¤§6æ™‚é–“ï¼ˆ360åˆ†ï¼‰ã¾ã§å®Ÿè¡Œå¯èƒ½ã§ã™"
          echo "âš ï¸ ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã«é”ã™ã‚‹ã¨è‡ªå‹•çš„ã«åœæ­¢ã—ã¾ã™"
          echo ""
          echo "ðŸ”„ Botã‚’èµ·å‹•ã—ã¦ã„ã¾ã™..."
          python src/main.py

      - name: å®Ÿè¡Œçµæžœã‚’ã‚µãƒžãƒªãƒ¼ã«å‡ºåŠ›
        if: always()
        run: |
          if [ '${{ job.status }}' == 'success' ]; then
            echo "## âœ… Discord Bot: æ­£å¸¸çµ‚äº†" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Botã¯æ­£å¸¸ã«çµ‚äº†ã—ã¾ã—ãŸã€‚" >> $GITHUB_STEP_SUMMARY
          elif [ '${{ job.status }}' == 'cancelled' ]; then
            echo "## â¹ï¸ Discord Bot: ã‚­ãƒ£ãƒ³ã‚»ãƒ«" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Botã®å®Ÿè¡ŒãŒã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œã¾ã—ãŸã€‚" >> $GITHUB_STEP_SUMMARY
          else
            echo "## âŒ Discord Bot: ã‚¨ãƒ©ãƒ¼çµ‚äº†" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Botã®å®Ÿè¡Œä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚" >> $GITHUB_STEP_SUMMARY
            echo "è©³ç´°ãªã‚¨ãƒ©ãƒ¼å†…å®¹ã¯ä¸Šè¨˜ã®ãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ç¢ºèªäº‹é …" >> $GITHUB_STEP_SUMMARY
            echo "1. **çŸ¥è­˜ãƒ‡ãƒ¼ã‚¿**: 'çŸ¥è­˜ãƒ‡ãƒ¼ã‚¿ã®ç”Ÿæˆã¨ä¿å­˜' ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’å®Ÿè¡Œæ¸ˆã¿ã‹" >> $GITHUB_STEP_SUMMARY
            echo "2. **DISCORD_TOKEN**: æ­£ã—ã„Bot ãƒˆãƒ¼ã‚¯ãƒ³ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹" >> $GITHUB_STEP_SUMMARY
            echo "3. **TARGET_GUILD_ID**: æ­£ã—ã„ã‚µãƒ¼ãƒãƒ¼IDãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹" >> $GITHUB_STEP_SUMMARY
            echo "4. **ENCRYPTION_KEY**: æš—å·éµãŒæ­£ã—ãè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹" >> $GITHUB_STEP_SUMMARY
            echo "5. **Botæ¨©é™**: BotãŒã‚µãƒ¼ãƒãƒ¼ã«å‚åŠ ã—ã¦ã„ã‚‹ã‹" >> $GITHUB_STEP_SUMMARY
            echo "6. **Intentè¨­å®š**: Discord Developer Portalã§å¿…è¦ãªIntentsãŒæœ‰åŠ¹åŒ–ã•ã‚Œã¦ã„ã‚‹ã‹" >> $GITHUB_STEP_SUMMARY
            echo "   - MESSAGE CONTENT INTENT" >> $GITHUB_STEP_SUMMARY
            echo "   - SERVER MEMBERS INTENT" >> $GITHUB_STEP_SUMMARY
            echo "   - GUILDS INTENT" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“ å®Ÿè¡Œæƒ…å ±" >> $GITHUB_STEP_SUMMARY
          echo "- **èµ·å‹•ç†ç”±**: ${{ github.event.inputs.reason || 'æ‰‹å‹•èµ·å‹•' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆè¨­å®š**: ${{ github.event.inputs.timeout_minutes || '60' }}åˆ†" >> $GITHUB_STEP_SUMMARY
          echo "- **å®Ÿè¡Œè€…**: @${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "- **å®Ÿè¡Œæ—¥æ™‚**: $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
