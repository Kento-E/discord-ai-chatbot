name: Enable Auto-Merge on PR Creation

on:
  pull_request:
    types: [opened, reopened, ready_for_review]

permissions:
  contents: write
  pull-requests: write

jobs:
  enable-auto-merge:
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false
    
    steps:
      - name: PRæƒ…å ±ã‚’è¡¨ç¤º
        run: |
          echo "PR #${{ github.event.pull_request.number }}: ${{ github.event.pull_request.title }}"
          echo "Base: ${{ github.event.pull_request.base.ref }}"
          echo "Head: ${{ github.event.pull_request.head.ref }}"
          echo "Author: ${{ github.event.pull_request.user.login }}"

      - name: GitHubã®è‡ªå‹•ãƒãƒ¼ã‚¸ã‚’æœ‰åŠ¹åŒ–
        uses: actions/github-script@v7
        with:
          script: |
            try {
              // GraphQL mutation ã‚’ä½¿ç”¨ã—ã¦ auto-merge ã‚’æœ‰åŠ¹åŒ–
              const mutation = `
                mutation($pullRequestId: ID!) {
                  enablePullRequestAutoMerge(input: {
                    pullRequestId: $pullRequestId,
                    mergeMethod: SQUASH
                  }) {
                    pullRequest {
                      id
                      number
                      autoMergeRequest {
                        enabledAt
                        enabledBy {
                          login
                        }
                      }
                    }
                  }
                }
              `;
              
              const result = await github.graphql(mutation, {
                pullRequestId: context.payload.pull_request.node_id
              });
              
              console.log('âœ… è‡ªå‹•ãƒãƒ¼ã‚¸ãŒæœ‰åŠ¹åŒ–ã•ã‚Œã¾ã—ãŸ');
              console.log(`PR #${result.enablePullRequestAutoMerge.pullRequest.number}`);
              console.log(`æœ‰åŠ¹åŒ–æ™‚åˆ»: ${result.enablePullRequestAutoMerge.pullRequest.autoMergeRequest.enabledAt}`);
              console.log('');
              console.log('ğŸ“ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—:');
              console.log('  1. ãƒ–ãƒ©ãƒ³ãƒä¿è­·ãƒ«ãƒ¼ãƒ«ã§è¦æ±‚ã•ã‚Œã‚‹æ‰¿èªã‚’å–å¾—');
              console.log('  2. ã™ã¹ã¦ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒã‚§ãƒƒã‚¯ãŒæˆåŠŸ');
              console.log('  3. â†’ è‡ªå‹•çš„ã«Squash and MergeãŒå®Ÿè¡Œã•ã‚Œã¾ã™');
            } catch (error) {
              if (error.message && error.message.includes('not allowed to enable auto-merge')) {
                console.log('â„¹ï¸  ã“ã®PRã§ã¯è‡ªå‹•ãƒãƒ¼ã‚¸ã‚’æœ‰åŠ¹åŒ–ã§ãã¾ã›ã‚“');
                console.log('ç†ç”±: ãƒ–ãƒ©ãƒ³ãƒä¿è­·ãƒ«ãƒ¼ãƒ«ã¾ãŸã¯æ¨©é™ã®åˆ¶ç´„');
                console.log('');
                console.log('ğŸ’¡ å›é¿ç­–:');
                console.log('  - æ‰¿èªå¾Œã€æ‰‹å‹•ã§ãƒãƒ¼ã‚¸ã—ã¦ãã ã•ã„');
                console.log('  - ã¾ãŸã¯ãƒ–ãƒ©ãƒ³ãƒä¿è­·ãƒ«ãƒ¼ãƒ«ã®è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„');
              } else {
                console.error('âŒ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:', error.message);
                // ã‚¨ãƒ©ãƒ¼ã§ã‚‚ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã¯æˆåŠŸæ‰±ã„ã«ã™ã‚‹ï¼ˆè‡´å‘½çš„ã§ã¯ãªã„ãŸã‚ï¼‰
              }
            }
