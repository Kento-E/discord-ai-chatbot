name: Auto Merge on Approval

on:
  pull_request_review:
    types: [submitted]

permissions:
  contents: write
  pull-requests: write

jobs:
  auto-merge:
    runs-on: ubuntu-latest
    if: github.event.review.state == 'approved'
    
    steps:
      - name: PR情報を取得
        id: pr
        uses: actions/github-script@v7
        with:
          script: |
            const pr = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.payload.pull_request.number
            });
            
            console.log(`PR #${pr.data.number}: ${pr.data.title}`);
            console.log(`Base: ${pr.data.base.ref}, Head: ${pr.data.head.ref}`);
            console.log(`Mergeable: ${pr.data.mergeable}`);
            console.log(`State: ${pr.data.state}`);
            
            return {
              number: pr.data.number,
              mergeable: pr.data.mergeable,
              state: pr.data.state,
              head_ref: pr.data.head.ref
            };

      - name: 承認数を確認
        id: check_approvals
        uses: actions/github-script@v7
        with:
          script: |
            const reviews = await github.rest.pulls.listReviews({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.payload.pull_request.number
            });
            
            // 最新のレビューのみを考慮（同じレビュアーの複数レビューがある場合）
            const latestReviews = {};
            for (const review of reviews.data) {
              const userId = review.user.id;
              if (!latestReviews[userId] || new Date(review.submitted_at) > new Date(latestReviews[userId].submitted_at)) {
                latestReviews[userId] = review;
              }
            }
            
            const approvals = Object.values(latestReviews).filter(r => r.state === 'APPROVED').length;
            console.log(`承認数: ${approvals}`);
            
            return approvals;

      - name: Squash and Merge実行
        if: fromJSON(steps.check_approvals.outputs.result) >= 1
        uses: actions/github-script@v7
        with:
          script: |
            try {
              const result = await github.rest.pulls.merge({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: context.payload.pull_request.number,
                merge_method: 'squash'
              });
              
              console.log('✅ PRが正常にマージされました');
              console.log(`SHA: ${result.data.sha}`);
              console.log(`Message: ${result.data.message}`);
            } catch (error) {
              console.error('❌ マージに失敗しました:', error.message);
              throw error;
            }
