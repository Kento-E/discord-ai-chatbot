name: Discord Secretsç–Žé€šãƒ†ã‚¹ãƒˆ

on:
  workflow_dispatch:  # æ‰‹å‹•å®Ÿè¡Œã‚’è¨±å¯
    inputs:
      reason:
        description: 'ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã™ã‚‹ç†ç”±ï¼ˆä»»æ„ï¼‰'
        required: false
        default: 'å®šæœŸçš„ãªç–Žé€šç¢ºèª'
  pull_request:  # PRèµ·ç¥¨æ™‚ã«è‡ªå‹•å®Ÿè¡Œ
    branches:
      - main
    types: [opened, reopened, synchronize]
  push:
    branches:
      - main
    paths:
      - '.github/workflows/test-secrets.yml'
      - 'src/test_connection.py'

permissions:
  contents: read

jobs:
  test-connection:
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4

      - name: Pythonã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: ä¾å­˜ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt

      - name: Discordç–Žé€šãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ
        env:
          DISCORD_TOKEN: ${{ secrets.DISCORD_TOKEN }}
          TARGET_GUILD_ID: ${{ secrets.TARGET_GUILD_ID }}
        run: |
          echo "ðŸ” Discord Secretsç–Žé€šãƒ†ã‚¹ãƒˆã‚’é–‹å§‹ã—ã¾ã™"
          echo "å®Ÿè¡Œç†ç”±: ${{ github.event.inputs.reason || 'è‡ªå‹•å®Ÿè¡Œ' }}"
          echo ""
          python src/test_connection.py

      - name: ãƒ†ã‚¹ãƒˆçµæžœã‚’ã‚µãƒžãƒªãƒ¼ã«å‡ºåŠ›
        if: always()
        run: |
          if [ ${{ job.status }} == 'success' ]; then
            echo "## âœ… Discord Secretsç–Žé€šãƒ†ã‚¹ãƒˆ: æˆåŠŸ" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "DISCORD_TOKENã¨TARGET_GUILD_IDã®ç–Žé€šãŒ" >> $GITHUB_STEP_SUMMARY
            echo "ç¢ºèªã§ãã¾ã—ãŸã€‚" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ç¢ºèªå†…å®¹" >> $GITHUB_STEP_SUMMARY
            echo "- âœ… DISCORD_TOKENã®æœ‰åŠ¹æ€§" >> $GITHUB_STEP_SUMMARY
            echo "- âœ… Discord APIã¸ã®æŽ¥ç¶š" >> $GITHUB_STEP_SUMMARY
            echo "- âœ… TARGET_GUILD_IDã§æŒ‡å®šã•ã‚ŒãŸã‚µãƒ¼ãƒãƒ¼ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹" >> $GITHUB_STEP_SUMMARY
          else
            echo "## âŒ Discord Secretsç–Žé€šãƒ†ã‚¹ãƒˆ: å¤±æ•—" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ç–Žé€šãƒ†ã‚¹ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚ä»¥ä¸‹ã‚’ç¢ºèªã—ã¦ãã ã•ã„:" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ç¢ºèªäº‹é …" >> $GITHUB_STEP_SUMMARY
            echo "1. **DISCORD_TOKEN**: æ­£ã—ã„Bot ãƒˆãƒ¼ã‚¯ãƒ³ãŒ" >> $GITHUB_STEP_SUMMARY
            echo "   è¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹" >> $GITHUB_STEP_SUMMARY
            echo "2. **TARGET_GUILD_ID**: æ­£ã—ã„ã‚µãƒ¼ãƒãƒ¼IDãŒ" >> $GITHUB_STEP_SUMMARY
            echo "   è¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹" >> $GITHUB_STEP_SUMMARY
            echo "3. **Botæ¨©é™**: BotãŒã‚µãƒ¼ãƒãƒ¼ã«" >> $GITHUB_STEP_SUMMARY
            echo "   Joinã—ã¦ã„ã‚‹ã‹" >> $GITHUB_STEP_SUMMARY
            echo "4. **Intentè¨­å®š**: Discord Developer Portalã§" >> $GITHUB_STEP_SUMMARY
            echo "   å¿…è¦ãªIntentsãŒæœ‰åŠ¹åŒ–ã•ã‚Œã¦ã„ã‚‹ã‹" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "è©³ç´°ãªã‚¨ãƒ©ãƒ¼å†…å®¹ã¯ä¸Šè¨˜ã®ãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚" >> $GITHUB_STEP_SUMMARY
          fi
