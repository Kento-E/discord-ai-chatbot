name: Secretsç–Žé€šãƒ†ã‚¹ãƒˆ

on:
  workflow_dispatch:  # æ‰‹å‹•å®Ÿè¡Œã‚’è¨±å¯
    inputs:
      reason:
        description: 'ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã™ã‚‹ç†ç”±ï¼ˆä»»æ„ï¼‰'
        required: false
        default: 'å®šæœŸçš„ãªç–Žé€šç¢ºèª'
      show_details:
        description: 'è©³ç´°æƒ…å ±ã‚’è¡¨ç¤ºï¼ˆã‚µãƒ¼ãƒãƒ¼åãƒ»Botåã‚’å–å¾—ã€Step Summaryã§ãƒªãƒã‚¸ãƒˆãƒªã®Actionsæ¨©é™ã‚’æŒã¤ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒé–²è¦§å¯èƒ½ï¼‰'
        required: false
        type: boolean
        default: false
      test_gemini:
        description: 'Gemini APIç–Žé€šãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œï¼ˆç„¡æ–™æž ã‚’æ¶ˆè²»ã—ã¾ã™ï¼‰'
        required: false
        type: boolean
        default: false
  push:
    branches:
      - main
    paths:
      - '.github/workflows/test-secrets.yml'
      - 'src/test_connection.py'
      - 'src/test_gemini_connection.py'

permissions:
  contents: read

jobs:
  test-connection:
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v6

      - name: Pythonã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-python@v6
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: ä¾å­˜ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt

      - name: Discordç–Žé€šãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ
        env:
          DISCORD_TOKEN: ${{ secrets.DISCORD_TOKEN }}
          TARGET_GUILD_ID: ${{ secrets.TARGET_GUILD_ID }}
          SHOW_DETAILS: ${{ github.event.inputs.show_details || 'false' }}
        run: |
          echo "ðŸ” Discord Secretsç–Žé€šãƒ†ã‚¹ãƒˆã‚’é–‹å§‹ã—ã¾ã™"
          echo "å®Ÿè¡Œç†ç”±: ${{ github.event.inputs.reason || 'è‡ªå‹•å®Ÿè¡Œ' }}"
          echo "è©³ç´°æƒ…å ±è¡¨ç¤º: ${{ github.event.inputs.show_details || 'false' }}"
          echo ""
          python src/test_connection.py

      - name: Gemini APIç–Žé€šãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ
        if: github.event.inputs.test_gemini == 'true'
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          echo ""
          echo "ðŸ” Gemini APIç–Žé€šãƒ†ã‚¹ãƒˆã‚’é–‹å§‹ã—ã¾ã™"
          echo ""
          python src/test_gemini_connection.py

      - name: ãƒ†ã‚¹ãƒˆçµæžœã‚’ã‚µãƒžãƒªãƒ¼ã«å‡ºåŠ›
        if: always()
        run: |
          if [ '${{ job.status }}' == 'success' ]; then
            echo "## âœ… Secretsç–Žé€šãƒ†ã‚¹ãƒˆ: æˆåŠŸ" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ç–Žé€šãƒ†ã‚¹ãƒˆã«æˆåŠŸã—ã¾ã—ãŸã€‚" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### DiscordæŽ¥ç¶š" >> $GITHUB_STEP_SUMMARY
            echo "- âœ… DISCORD_TOKENã®æœ‰åŠ¹æ€§" >> $GITHUB_STEP_SUMMARY
            echo "- âœ… Discord APIã¸ã®æŽ¥ç¶š" >> $GITHUB_STEP_SUMMARY
            echo "- âœ… TARGET_GUILD_IDã§æŒ‡å®šã•ã‚ŒãŸã‚µãƒ¼ãƒãƒ¼ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            if [ "${{ github.event.inputs.test_gemini }}" == "true" ]; then
              echo "### Gemini APIæŽ¥ç¶š" >> $GITHUB_STEP_SUMMARY
              echo "- âœ… GEMINI_API_KEYã®æœ‰åŠ¹æ€§" >> $GITHUB_STEP_SUMMARY
              echo "- âœ… Gemini APIã¸ã®æŽ¥ç¶š" >> $GITHUB_STEP_SUMMARY
              echo "- âœ… LLMãƒ¢ãƒ¼ãƒ‰ãŒåˆ©ç”¨å¯èƒ½" >> $GITHUB_STEP_SUMMARY
            else
              echo "### Gemini APIæŽ¥ç¶š" >> $GITHUB_STEP_SUMMARY
              if [ "${{ github.event_name }}" == "push" ]; then
                echo "- â­ï¸ ã‚¹ã‚­ãƒƒãƒ—ï¼ˆè‡ªå‹•å®Ÿè¡Œæ™‚ã¯å®Ÿè¡Œã•ã‚Œã¾ã›ã‚“ï¼‰" >> $GITHUB_STEP_SUMMARY
              else
                echo "- â­ï¸ ã‚¹ã‚­ãƒƒãƒ—ï¼ˆæ‰‹å‹•å®Ÿè¡Œæ™‚ã«ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã§æœ‰åŠ¹åŒ–å¯èƒ½ï¼‰" >> $GITHUB_STEP_SUMMARY
              fi
            fi
          else
            echo "## âŒ Secretsç–Žé€šãƒ†ã‚¹ãƒˆ: å¤±æ•—" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ç–Žé€šãƒ†ã‚¹ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚ä»¥ä¸‹ã‚’ç¢ºèªã—ã¦ãã ã•ã„:" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### DiscordæŽ¥ç¶šã®ç¢ºèªäº‹é …" >> $GITHUB_STEP_SUMMARY
            echo "1. **DISCORD_TOKEN**: æ­£ã—ã„Bot ãƒˆãƒ¼ã‚¯ãƒ³ãŒ" >> $GITHUB_STEP_SUMMARY
            echo "   è¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹" >> $GITHUB_STEP_SUMMARY
            echo "2. **TARGET_GUILD_ID**: æ­£ã—ã„ã‚µãƒ¼ãƒãƒ¼IDãŒ" >> $GITHUB_STEP_SUMMARY
            echo "   è¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹" >> $GITHUB_STEP_SUMMARY
            echo "3. **Botæ¨©é™**: BotãŒã‚µãƒ¼ãƒãƒ¼ã«" >> $GITHUB_STEP_SUMMARY
            echo "   Joinã—ã¦ã„ã‚‹ã‹" >> $GITHUB_STEP_SUMMARY
            echo "4. **Intentè¨­å®š**: Discord Developer Portalã§" >> $GITHUB_STEP_SUMMARY
            echo "   å¿…è¦ãªIntentsãŒæœ‰åŠ¹åŒ–ã•ã‚Œã¦ã„ã‚‹ã‹" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            if [ "${{ github.event.inputs.test_gemini }}" == "true" ]; then
              echo "### Gemini APIæŽ¥ç¶šã®ç¢ºèªäº‹é …" >> $GITHUB_STEP_SUMMARY
              echo "1. **GEMINI_API_KEY**: æ­£ã—ã„APIã‚­ãƒ¼ãŒ" >> $GITHUB_STEP_SUMMARY
              echo "   è¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹" >> $GITHUB_STEP_SUMMARY
              echo "2. **APIã‚­ãƒ¼ã®æœ‰åŠ¹æ€§**: Google AI Studioã§" >> $GITHUB_STEP_SUMMARY
              echo "   APIã‚­ãƒ¼ãŒæœ‰åŠ¹ã‹ç¢ºèª" >> $GITHUB_STEP_SUMMARY
              echo "3. **ãƒ¬ãƒ¼ãƒˆåˆ¶é™**: ç„¡æ–™æž ã®åˆ¶é™ã«" >> $GITHUB_STEP_SUMMARY
              echo "   é”ã—ã¦ã„ãªã„ã‹ç¢ºèª" >> $GITHUB_STEP_SUMMARY
              echo "4. **ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆæŽ¥ç¶š**: APIã¸ã®æŽ¥ç¶šãŒ" >> $GITHUB_STEP_SUMMARY
              echo "   å¯èƒ½ã‹ç¢ºèª" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "**æ³¨æ„**: GEMINI_API_KEYã¯ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã§ã™ã€‚" >> $GITHUB_STEP_SUMMARY
              echo "è¨­å®šã•ã‚Œã¦ã„ãªã„å ´åˆã¯æ¨™æº–ãƒ¢ãƒ¼ãƒ‰ï¼ˆãƒšãƒ«ã‚½ãƒŠãƒ™ãƒ¼ã‚¹ï¼‰ã§å‹•ä½œã—ã¾ã™ã€‚" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
            fi
            echo "è©³ç´°ãªã‚¨ãƒ©ãƒ¼å†…å®¹ã¯ä¸Šè¨˜ã®ãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚" >> $GITHUB_STEP_SUMMARY
          fi
