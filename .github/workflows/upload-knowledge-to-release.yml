name: çŸ¥è­˜ãƒ‡ãƒ¼ã‚¿ã®Releaseè‡ªå‹•ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰

on:
  workflow_run:
    workflows: ["çŸ¥è­˜ãƒ‡ãƒ¼ã‚¿ã®ç”Ÿæˆã¨ä¿å­˜"]
    types:
      - completed

concurrency:
  group: upload-knowledge-release
  cancel-in-progress: false

permissions:
  contents: write

jobs:
  upload-to-release:
    runs-on: ubuntu-latest
    # å…ƒã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãŒæˆåŠŸã—ãŸå ´åˆã®ã¿å®Ÿè¡Œ
    if: ${{ github.event.workflow_run.conclusion == 'success' }}

    steps:
      - name: ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v6

      - name: æš—å·åŒ–ã•ã‚ŒãŸçŸ¥è­˜ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
        uses: actions/download-artifact@v6
        with:
          name: knowledge-data-encrypted
          github-token: ${{ secrets.GITHUB_TOKEN }}
          run-id: ${{ github.event.workflow_run.id }}

      - name: ã‚¿ã‚°åã¨ãƒªãƒªãƒ¼ã‚¹åã‚’ç”Ÿæˆ
        id: generate-tag
        run: |
          # ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ãƒ™ãƒ¼ã‚¹ã®ã‚¿ã‚°åã‚’ç”Ÿæˆ
          TIMESTAMP=$(date -u +'%Y%m%d-%H%M%S')
          TAG_NAME="knowledge-data-${TIMESTAMP}-${{ github.event.workflow_run.id }}"
          RELEASE_NAME="çŸ¥è­˜ãƒ‡ãƒ¼ã‚¿ ${TIMESTAMP}"

          echo "tag_name=${TAG_NAME}" >> $GITHUB_OUTPUT
          echo "release_name=${RELEASE_NAME}" >> $GITHUB_OUTPUT
          echo "timestamp=${TIMESTAMP}" >> $GITHUB_OUTPUT

          echo "ðŸ“¦ ç”Ÿæˆã•ã‚ŒãŸã‚¿ã‚°å: ${TAG_NAME}"
          echo "ðŸ“¦ ãƒªãƒªãƒ¼ã‚¹å: ${RELEASE_NAME}"

      - name: GitHub Releaseã‚’ä½œæˆã—ã¦ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG_NAME="${{ steps.generate-tag.outputs.tag_name }}"
          RELEASE_NAME="${{ steps.generate-tag.outputs.release_name }}"

          echo "ðŸš€ GitHub Releaseã‚’ä½œæˆä¸­..."

          # ãƒªãƒªãƒ¼ã‚¹ãƒŽãƒ¼ãƒˆã‚’ä½œæˆ
          cat > release-notes.md << 'EOF'
          ## çŸ¥è­˜ãƒ‡ãƒ¼ã‚¿è‡ªå‹•ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰

          ã“ã®ãƒªãƒªãƒ¼ã‚¹ã«ã¯ã€Discord ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰å–å¾—ã—ãŸæš—å·åŒ–æ¸ˆã¿çŸ¥è­˜ãƒ‡ãƒ¼ã‚¿ãŒå«ã¾ã‚Œã¦ã„ã¾ã™ã€‚

          ### ðŸ“¦ å«ã¾ã‚Œã‚‹ãƒ•ã‚¡ã‚¤ãƒ«
          - `knowledge-data.enc`: æš—å·åŒ–ã•ã‚ŒãŸçŸ¥è­˜ãƒ‡ãƒ¼ã‚¿ï¼ˆmessages.json + embeddings.jsonï¼‰

          ### ðŸ” æš—å·åŒ–æƒ…å ±
          - **ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ **: AES-256-CBC
          - **å½¢å¼**: tar.gz + OpenSSLæš—å·åŒ–

          ### ðŸ“ ä½¿ç”¨æ–¹æ³•
          ã“ã®ãƒ‡ãƒ¼ã‚¿ã¯ `Discord Botã®å®Ÿè¡Œ` ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã§è‡ªå‹•çš„ã«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒ»å¾©å·åŒ–ã•ã‚Œã¾ã™ã€‚

          ### â±ï¸ ç”Ÿæˆæ—¥æ™‚
          - **UTC**: ${{ steps.generate-tag.outputs.timestamp }}
          - **ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®Ÿè¡ŒID**: ${{ github.event.workflow_run.id }}

          ---
          è‡ªå‹•ç”Ÿæˆ: [`çŸ¥è­˜ãƒ‡ãƒ¼ã‚¿ã®ç”Ÿæˆã¨ä¿å­˜`](${{ github.event.workflow_run.html_url }}) ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼
          EOF

          # ãƒ•ã‚¡ã‚¤ãƒ«ã®å­˜åœ¨ç¢ºèª
          if [ ! -f knowledge-data.enc ]; then
            echo "âŒ ã‚¨ãƒ©ãƒ¼: knowledge-data.enc ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
            exit 1
          fi

          # Releaseã‚’ä½œæˆ
          gh release create "${TAG_NAME}" \
            --title "${RELEASE_NAME}" \
            --notes-file release-notes.md \
            knowledge-data.enc

          echo "âœ… Releaseã®ä½œæˆãŒå®Œäº†ã—ã¾ã—ãŸ"
          echo "ðŸ”— Release URL: https://github.com/${{ github.repository }}/releases/tag/${TAG_NAME}"

      - name: å¤ã„Releaseã‚’å‰Šé™¤ï¼ˆæœ€æ–°5ä»¶ã‚’ä¿æŒï¼‰
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ðŸ—‘ï¸ å¤ã„Releaseã‚’å‰Šé™¤ä¸­..."

          # knowledge-data-* ã‚¿ã‚°ã®Releaseã‚’å–å¾—ï¼ˆä½œæˆæ—¥æ™‚é™é †ï¼‰
          RELEASES=$(gh release list --limit 100 --json tagName,createdAt \
            --jq '[.[] | select(.tagName | startswith("knowledge-data-"))] | sort_by(.createdAt) | reverse | .[].tagName')

          # é…åˆ—ã«å¤‰æ›
          RELEASE_ARRAY=($RELEASES)
          TOTAL=${#RELEASE_ARRAY[@]}

          echo "ðŸ“Š knowledge-data-* Releaseã®ç·æ•°: ${TOTAL}"

          # 6ä»¶ç›®ä»¥é™ã‚’å‰Šé™¤ï¼ˆæœ€æ–°5ä»¶ã‚’ä¿æŒï¼‰
          if [ $TOTAL -gt 5 ]; then
            echo "ðŸ—‘ï¸ å¤ã„Releaseã‚’å‰Šé™¤ã—ã¾ã™ï¼ˆä¿æŒ: 5ä»¶ï¼‰"
            for i in $(seq 5 $((TOTAL - 1))); do
              TAG="${RELEASE_ARRAY[$i]}"
              echo "  - å‰Šé™¤ä¸­: ${TAG}"
              gh release delete "${TAG}" --yes --cleanup-tag || true
            done
            echo "âœ… å‰Šé™¤å®Œäº†"
          else
            echo "âœ… å‰Šé™¤å¯¾è±¡ã®Releaseã¯ã‚ã‚Šã¾ã›ã‚“ï¼ˆç¾åœ¨: ${TOTAL}ä»¶ï¼‰"
          fi

      - name: å®Ÿè¡Œçµæžœã‚’ã‚µãƒžãƒªãƒ¼ã«å‡ºåŠ›
        if: always()
        run: |
          if [ '${{ job.status }}' == 'success' ]; then
            echo "## âœ… çŸ¥è­˜ãƒ‡ãƒ¼ã‚¿ã®Releaseè‡ªå‹•ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰: æˆåŠŸ" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "çŸ¥è­˜ãƒ‡ãƒ¼ã‚¿ãŒæ­£å¸¸ã«GitHub Releaseã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¾ã—ãŸã€‚" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ðŸ“¦ Releaseæƒ…å ±" >> $GITHUB_STEP_SUMMARY
            echo "- **ã‚¿ã‚°å**: \`${{ steps.generate-tag.outputs.tag_name }}\`" >> $GITHUB_STEP_SUMMARY
            echo "- **ãƒªãƒªãƒ¼ã‚¹å**: ${{ steps.generate-tag.outputs.release_name }}" >> $GITHUB_STEP_SUMMARY
            echo "- **ãƒ•ã‚¡ã‚¤ãƒ«**: knowledge-data.enc" >> $GITHUB_STEP_SUMMARY
            echo "- **URL**: https://github.com/${{ github.repository }}/releases/tag/${{ steps.generate-tag.outputs.tag_name }}" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ðŸ”„ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—" >> $GITHUB_STEP_SUMMARY
            echo "Discord Botã‚’èµ·å‹•ã™ã‚‹éš›ã€ã“ã®Releaseã‹ã‚‰çŸ¥è­˜ãƒ‡ãƒ¼ã‚¿ãŒè‡ªå‹•çš„ã«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¾ã™ã€‚" >> $GITHUB_STEP_SUMMARY
          else
            echo "## âŒ çŸ¥è­˜ãƒ‡ãƒ¼ã‚¿ã®Releaseè‡ªå‹•ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰: å¤±æ•—" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "çŸ¥è­˜ãƒ‡ãƒ¼ã‚¿ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ç¢ºèªäº‹é …" >> $GITHUB_STEP_SUMMARY
            echo "1. **å…ƒã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼**: 'çŸ¥è­˜ãƒ‡ãƒ¼ã‚¿ã®ç”Ÿæˆã¨ä¿å­˜' ãŒæ­£å¸¸ã«å®Œäº†ã—ã¦ã„ã‚‹ã‹" >> $GITHUB_STEP_SUMMARY
            echo "2. **ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆ**: knowledge-data-encrypted ãŒæ­£ã—ãä¿å­˜ã•ã‚Œã¦ã„ã‚‹ã‹" >> $GITHUB_STEP_SUMMARY
            echo "3. **æ¨©é™**: ã“ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã« contents: write æ¨©é™ãŒã‚ã‚‹ã‹" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“ å®Ÿè¡Œæƒ…å ±" >> $GITHUB_STEP_SUMMARY
          echo "- **å…ƒã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼**: [\`çŸ¥è­˜ãƒ‡ãƒ¼ã‚¿ã®ç”Ÿæˆã¨ä¿å­˜\`](${{ github.event.workflow_run.html_url }})" >> $GITHUB_STEP_SUMMARY
          echo "- **ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®Ÿè¡ŒID**: ${{ github.event.workflow_run.id }}" >> $GITHUB_STEP_SUMMARY
          echo "- **å®Ÿè¡Œæ—¥æ™‚**: $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
