# プロンプトエンジニアリングガイド

このガイドでは、Discord AI Chatbotのプロンプトをカスタマイズして、応答の品質や性格を調整する方法を説明します。

## 目次

- [概要](#概要)
- [環境変数による設定](#環境変数による設定)
- [設定ファイルによる設定](#設定ファイルによる設定)
- [実践例](#実践例)
- [ベストプラクティス](#ベストプラクティス)
- [トラブルシューティング](#トラブルシューティング)

## 概要

チャットボットの応答品質を向上させるには、適切なプロンプトエンジニアリングが重要です。このBotでは、以下の2つの方法でプロンプトをカスタマイズできます：

1. **環境変数**: 実行時にプロンプトを動的に変更
2. **設定ファイル**: `config/prompts.yaml` でデフォルト設定を定義

環境変数を使用すると、設定ファイルを変更せずにプロンプトをカスタマイズできます。これはGitHub Actionsでの実行時に特に便利です。

## 環境変数による設定

### 利用可能な環境変数

| 環境変数名 | 説明 | 優先度 |
|----------|------|-------|
| `CUSTOM_SYSTEM_PROMPT` | システムプロンプト全体を上書き | 高 |
| `CUSTOM_RESPONSE_INSTRUCTION` | 応答生成の指示を上書き | 高 |
| `CUSTOM_CONTEXT_HEADER` | コンテキストヘッダーを上書き | 中 |
| `CUSTOM_QUERY_HEADER` | クエリヘッダーを上書き | 中 |
| `CUSTOM_RESPONSE_HEADER` | レスポンスヘッダーを上書き | 中 |
| `ADDITIONAL_CHATBOT_ROLE` | システムプロンプトに追加の役割を追加 | 中 |

### 設定の優先順位

1. 環境変数 `CUSTOM_*` が最優先
2. 設定ファイル `config/prompts.yaml` がデフォルト
3. 環境変数 `ADDITIONAL_CHATBOT_ROLE` はシステムプロンプトに追加される

### ローカル環境での使用

```bash
# 環境変数を設定
export CUSTOM_SYSTEM_PROMPT="あなたは親しみやすいアシスタントです。"
export CUSTOM_RESPONSE_INSTRUCTION="簡潔に回答してください。500文字以内に収めてください。"

# Botを起動
python src/main.py
```

### GitHub Actions上での使用

1. GitHubリポジトリの「Settings」→「Secrets and variables」→「Actions」を開く
2. 必要な環境変数を「New repository secret」で追加
3. Discord Botの実行ワークフローを実行

例：
```
Name: CUSTOM_SYSTEM_PROMPT
Value: あなたは技術サポートの専門家です。過去のメッセージを参照して、技術的な質問に詳しく回答してください。
```

## 設定ファイルによる設定

### prompts.yamlの構造

```yaml
# システムプロンプト（LLMへの基本指示）
llm_system_prompt: |
  あなたの基本的な性格や役割を定義します。
  複数行にわたって記述できます。

# 回答生成の指示
llm_response_instruction: |
  応答を生成する際のルールを定義します。
  1. ルール1
  2. ルール2
  3. ルール3

# セクションヘッダー
llm_context_header: "【過去メッセージ】"
llm_query_header: "【ユーザーの質問】"
llm_response_header: "【回答】"
```

### 設定ファイルの編集

1. `config/prompts.yaml` を編集
2. Botを再起動（変更を反映）

**注意**: GitHub Actions上で動作させる場合、設定ファイルの変更はリポジトリにコミットする必要があります。

## 実践例

### 例1: フレンドリーなコミュニティアシスタント

```bash
export CUSTOM_SYSTEM_PROMPT="あなたは親しみやすく、フレンドリーなDiscordコミュニティのアシスタントです。過去の会話を参考にしながら、温かく丁寧に回答してください。絵文字を適度に使用して、親しみやすい雰囲気を作ってください。"

export ADDITIONAL_CHATBOT_ROLE="カジュアルで親しみやすい口調で話してください。タメ口や友達に話すような雰囲気で回答してください。"
```

### 例2: 技術サポート専門家

```bash
export CUSTOM_SYSTEM_PROMPT="あなたは技術的な質問に答える専門家です。過去のメッセージから得られる技術的な情報を最優先し、正確で詳細な回答を提供してください。コードやコマンドの例を含めることを推奨します。"

export CUSTOM_RESPONSE_INSTRUCTION="以下のルールに従って回答してください：
1. 技術的に正確な情報を提供する
2. コード例やコマンド例を含める
3. 過去のメッセージから関連する技術情報を引用する
4. 専門用語を使用しても構いませんが、必要に応じて説明を加える
5. 2000文字以内に収める"
```

### 例3: 簡潔な回答スタイル

```bash
export CUSTOM_RESPONSE_INSTRUCTION="以下のルールに従って、簡潔に回答してください：
1. 要点を絞り、短く明確に回答する
2. 箇条書きを活用する
3. 過去メッセージの情報を優先する
4. 500文字以内に収める"
```

### 例4: ビジネスライクなアシスタント

```bash
export CUSTOM_SYSTEM_PROMPT="あなたはプロフェッショナルなビジネスアシスタントです。過去のメッセージを参考にしながら、丁寧で礼儀正しく回答してください。"

export ADDITIONAL_CHATBOT_ROLE="丁寧で礼儀正しい、ビジネスライクな口調で回答してください。敬語を使用し、プロフェッショナルな態度を保ってください。"
```

### 例5: カスタムヘッダーの使用

```bash
export CUSTOM_CONTEXT_HEADER="【参考情報】"
export CUSTOM_QUERY_HEADER="【お問い合わせ内容】"
export CUSTOM_RESPONSE_HEADER="【ご回答】"
```

## ベストプラクティス

### 1. 知識データとの整合性を保つ

プロンプトを設計する際は、Botが学習した過去メッセージの内容やトーンと整合性を保つことが重要です。

**良い例**:
```
過去のメッセージから得られる情報を最優先し、コミュニティの雰囲気を保ちながら回答してください。
```

**悪い例**:
```
過去のメッセージを無視して、一般的な知識のみで回答してください。
```

### 2. 明確で具体的な指示を与える

曖昧な指示ではなく、具体的で明確な指示を与えることで、一貫性のある回答が得られます。

**良い例**:
```
1. 挨拶や前置きは不要。質問に対して直接回答する
2. 箇条書きを活用して、要点を整理する
3. 500文字以内に収める
```

**悪い例**:
```
良い感じに回答してください。
```

### 3. 文字数制限を適切に設定する

Discordのメッセージは2000文字までに制限されています。プロンプトで文字数制限を指定することで、確実に収まるようにします。

**推奨**:
```
必ず1800文字以内に収めてください。
```

### 4. テストと反復

プロンプトを変更したら、必ず実際にBotに質問してテストしてください。期待通りの回答が得られない場合は、プロンプトを調整します。

### 5. 段階的な調整

大きな変更を一度に行うのではなく、小さな変更を段階的に行い、その効果を確認しながら調整します。

## トラブルシューティング

### プロンプトが反映されない

**原因**: キャッシュが有効になっている可能性があります。

**解決策**: Botを再起動してください。環境変数を変更した場合、自動的にキャッシュが無効化されるはずですが、問題が続く場合は完全に再起動してください。

### 応答が長すぎる

**原因**: 文字数制限の指示が不十分です。

**解決策**: `CUSTOM_RESPONSE_INSTRUCTION` で明確な文字数制限を指定してください。

```bash
export CUSTOM_RESPONSE_INSTRUCTION="必ず1800文字以内に収めてください。要点を絞り、簡潔に回答してください。"
```

### 応答がコンテキストに沿っていない

**原因**: システムプロンプトで知識データの優先順位が明確でない可能性があります。

**解決策**: システムプロンプトで過去メッセージの優先度を明記してください。

```bash
export CUSTOM_SYSTEM_PROMPT="あなたは過去メッセージから学習したアシスタントです。過去メッセージに関連情報がある場合、その内容を最優先して回答してください。一般的な知識は補足としてのみ使用してください。"
```

### GitHub Actions上で環境変数が反映されない

**原因**: Secretが正しく設定されていない、またはワークフローファイルで環境変数として渡されていません。

**解決策**:
1. GitHubの「Settings」→「Secrets and variables」→「Actions」で、Secretが正しく設定されているか確認
2. `.github/workflows/run-discord-bot.yml` で、環境変数が `env:` セクションに含まれているか確認

### エラー: "プロンプト設定ファイルが見つかりません"

**原因**: `config/prompts.yaml` ファイルが存在しません。

**解決策**:
1. `config/prompts.yaml.example` を `config/prompts.yaml` にコピー
2. または、`config/` ディレクトリに `prompts.yaml` ファイルを作成

```bash
cp config/prompts.yaml.example config/prompts.yaml
```

## まとめ

プロンプトエンジニアリングは、チャットボットの応答品質を向上させる強力な手段です。このガイドで紹介した方法を参考に、あなたのコミュニティに最適なプロンプトを見つけてください。

さらに詳しい情報や質問がある場合は、リポジトリのIssueで質問してください。
