# チャットボットの追加役割指定機能

## 概要

この機能により、設定ファイル（`config/prompts.yaml`）のベースプロンプトに加えて、環境変数を通じて追加の役割や性格をチャットボットに指定できます。

## 使用目的

- 業務に関わる内容や非公開にしたい具体的な役割をGitHub Secretsで管理
- プロジェクトやチーム固有の性格設定を柔軟に追加
- ベースプロンプトを変更せずに、環境ごとに異なる役割を適用

## 設定方法

### ローカル環境

環境変数 `ADDITIONAL_CHATBOT_ROLE` を設定してBotを起動します。

```bash
export ADDITIONAL_CHATBOT_ROLE="あなたは経験豊富なシニアエンジニアです。
技術的な質問に対して、以下の点を重視して回答してください：
- ベストプラクティスの提案
- セキュリティへの配慮
- パフォーマンスの最適化"

python src/main.py
```

### GitHub Actions

1. GitHubリポジトリの「Settings」→「Secrets and variables」→「Actions」を開く
2. 新しいSecretを追加：
   - **Name**: `ADDITIONAL_CHATBOT_ROLE`
   - **Value**: 追加したい役割の説明（複数行可）

例：

```
あなたは親切で丁寧なカスタマーサポート担当者です。
以下の特徴があります：
- ユーザーの質問に共感的に対応する
- 分かりやすい言葉で説明する
- 必要に応じて具体例を示す
```

3. ワークフローを実行すると、自動的に適用されます

## 動作の仕組み

### プロンプトの統合

`ADDITIONAL_CHATBOT_ROLE` が設定されている場合、システムプロンプトは以下のように構成されます：

```
<config/prompts.yaml のベースシステムプロンプト>

【追加の役割・性格】
<ADDITIONAL_CHATBOT_ROLE の内容>
```

### 例

**ベースプロンプト（config/prompts.yaml）:**

```yaml
llm_system_prompt: |
  あなたはクローズドなDiscordサーバー内で蓄積された過去メッセージから学習した専門AIアシスタントです。
```

**環境変数:**

```bash
ADDITIONAL_CHATBOT_ROLE="あなたは業務効率化の専門家です。
常に効率とコスト削減を重視した提案を行ってください。"
```

**統合後のプロンプト:**

```
あなたはクローズドなDiscordサーバー内で蓄積された過去メッセージから学習した専門AIアシスタントです。

【追加の役割・性格】
あなたは業務効率化の専門家です。
常に効率とコスト削減を重視した提案を行ってください。
```

## 注意事項

### セキュリティ

- **GitHub Secrets**: GitHub Secretsに保存された値は暗号化され、許可されたユーザーのみが閲覧可能です
- **Variables vs Secrets**: GitHub Variablesはリポジトリの閲覧権限があれば誰でも見られますが、Secretsは設定した本人以外は閲覧できません。機密情報はSecretsを使用してください

### 使用上の留意点

- 追加の役割は、ベースプロンプトと矛盾しないように設定してください
- 複雑すぎる指示はLLMの応答品質に影響する可能性があります
- 環境変数が設定されていない、または空の場合は、ベースプロンプトのみが使用されます

### パフォーマンス

- プロンプト設定は初回読み込み時にキャッシュされます
- **環境変数の変更は自動的に検出され、キャッシュが無効化されます**
  - 環境変数が変更されると「🔄 追加の役割設定が変更されました。プロンプトを再読み込みします」と表示されます
  - Botの再起動は不要で、次回の応答生成時に新しい値が反映されます
- 追加の役割が設定されている場合、起動時に「✅ 追加の役割設定が適用されました」と表示されます
- システムプロンプトの長さが増えるため、若干のトークン消費量の増加があります

## テスト

この機能は以下の観点で包括的にテストされています：

- 追加の役割が設定されていない場合の動作（既存動作の維持）
- 追加の役割が正しく統合されること
- 空文字列や空白文字のみの場合の処理
- 複数行の役割指定
- キャッシュ機能との互換性

機能の動作確認は、既存のプロンプト読み込みテスト（`python src/test_prompts_loading.py`）が引き続き成功することで検証できます。

## トラブルシューティング

### 追加の役割が適用されない

**確認事項:**

1. 環境変数名が正しいか（`ADDITIONAL_CHATBOT_ROLE`）
2. GitHub Secretsが正しく設定されているか
3. ワークフローファイルで環境変数が渡されているか（`.github/workflows/run-discord-bot.yml`）
4. 起動ログに「✅ 追加の役割設定が適用されました」と表示されているか

### 応答が期待通りでない

**考えられる原因:**

1. 追加の役割とベースプロンプトが矛盾している
2. 指示が複雑すぎて、LLMが正しく解釈できていない
3. プロンプトが長すぎて、トークン制限に近づいている

**対処法:**

- 追加の役割をシンプルにする
- ベースプロンプトとの整合性を確認する
- 複数の指示を箇条書きで明確に記述する

## 関連ファイル

- 実装: `src/ai_chatbot.py` - `_load_prompts()` 関数
- テスト: `src/test_prompts_loading.py` - 既存のプロンプト読み込みテストで動作検証
- ワークフロー: `.github/workflows/run-discord-bot.yml`
- ベースプロンプト: `config/prompts.yaml`
